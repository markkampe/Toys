#!/bin/bash
#	a single command to start up my standard desktop
LOG=$HOME/desktop.log	# where to capture stardup stdout/stderr
DELAY=2			# wait for window to be created

# optional debug argument
if [ -n "$1" ]
then
    DEBUG="True"
else
    DEBUG=""
fi

#figure out our screen geometry
TEMP=/tmp/screens_$$
xrandr | grep ' connected' > $TEMP
screens=`cat $TEMP | wc -l`
if [ $screens -ne 2 ]
then
    echo "ERROR: we seem to have $screens screens" >&2
    exit -1
fi

# get the geometries and locations of our two screens
l1=`grep primary $TEMP`
d1=`echo $l1 | cut -d' ' -f1`
s1=`echo $l1 | cut -d' ' -f4`
w1=`echo $s1 | cut -dx -f1`
h1=`echo $s1 | cut -dx -f2 | cut -d+ -f1`
x1=`echo $s1 | cut -d+ -f2`
y1=`echo $s1 | cut -d+ -f3`

l2=`grep -v primary $TEMP`
d2=`echo $l2 | cut -d' ' -f1`
s2=`echo $l2 | cut -d' ' -f3`
w2=`echo $s2 | cut -dx -f1`
h2=`echo $s2 | cut -dx -f2 | cut -d+ -f1`
x2=`echo $s2 | cut -d+ -f2`
y2=`echo $s2 | cut -d+ -f3`

# figure out which is left and which is right
if [ $x1 -eq 0 ]
then
    if [ -n "$DEBUG" ]
    then
        echo "   primary:   $d1 "$w1"x"$h1" @<$x1,$y1>"
    fi
    L_WIDTH=$w1
    L_HEIGHT=$h1
    L_PRIMARY="(P)"
    R_WIDTH=$w2
    R_HEIGHT=$h2
    R_PRIMARY=""
else
    if [ -n "$DEBUG" ]
    then
    i   echo "   secondary: $d2 "$w2"x"$h2" @<$x2,$y2>"		# DEBUG
    fi
    L_WIDTH=$w2
    L_HEIGHT=$h2
    L_PRIMARY=""
    R_WIDTH=$w1
    R_HEIGHT=$h1
    R_PRIMARY="(p)"
fi

L_MARGIN=20	# width of app menu bar (on left side of primary)

# default configuration (likely to be changed by .desktop)
WINDOWS="Home"
Home_TABS="https://calendar.google.com/calendar/u/0/r/month"
Home_DIR="/home/markk"

if [ -r $HOME/.desktop ]
then
    echo using desktop configuration from $HOME/.desktop >> $LOG
    . $HOME/.desktop
fi
echo "    screens:  $L_WIDTH"x"$L_HEIGHT""$L_PRIMARY and $R_WIDTH"x"$R_HEIGHT""$R_PRIMARH"
echo "    app bar:  $L_MARGIN wide"

# compute x-term window sizes
if [ $L_WIDTH -lt $R_WIDTH ]
then
    XT_WIDTH=$((6 * $L_WIDTH / 10))
else
    XT_WIDTH=$((6 * $R_WIDTH / 10))
fi
XT_LHIGH=$((4 * $L_HEIGHT / 5))
XT_RHIGH=$((4 * $R_HEIGHT / 5))
echo "    xterms:   $XT_WIDTH"x"$XT_LHIGH@<5,5> and $XT_WIDTH"x"$XT_RHIGH@<$L_WIDTH,5>"

# compute browser window size/position for LHS browsers
B_WIDTH=$((95 * $L_WIDTH / 100 - $L_MARGIN)) # don't use full width
B_LENGTH=$((2 * $L_HEIGHT / 3))		# don't use full height
B_SIZE="--window-size=$B_WIDTH,$B_LENGTH"
B_DOWN=2				# avoid full screen
B_LEFT=2				# avoid app menu
B_POS="--window-position=$B_LEFT,$B_DOWN"
echo "    browsers: $B_WIDTH"x"$B_LENGTH@<$B_LEFT,$B_DOWN>"

# if we are testing, don't actually start any processes
if [ -n "$DEBUG" ]
then
    exit 0
fi

date > $LOG
WS=0

if [ -z "$1" ]
then
   run () { eval $1; }
else
   run () { echo $1; }
fi

# per every window commands
for t in $WINDOWS
do
    echo "initializing workspace $t ($WS)"
    run "wmctrl -s $WS"
    sleep $DELAY

    
    # figure out what tabs and directory to use
    TABS=`eval echo "$""$t""_TABS"`
    DIR=`eval echo "$""$t""_DIR"`
    
    echo "... starting UXterms for $WS: $t in $DIR"
    cd $DIR
    if [ $WS -ne 0 ]
    then
    	# this was created manually in WS0
        run "uxterm -title $t-lhs &"
    else
	# title the xterm in which we are runnin
    	echo -ne '\033]2;Home-lhs\007'
    fi
    run "uxterm -title $t-rhs &"

    # see if this window has defined browser tabs
    if [ -n "$TABS" ]
    then
	echo "... starting Chrome window for $t"
	run "google-chrome-stable --new-window $B_SIZE $B_POS $TABS >>$LOG 2>>$LOG &"
    fi

    # ... placing and sizing XTERMs for $WS: $t
    sleep $DELAY

    if [ $WS -ne 0 ]
    then
	# this was created manually in WS0
	run "wmctrl -r $t-lhs -e 0,5,5,$XT_WIDTH,$XT_LHIGH"
    fi
    run "wmctrl -r $t-rhs -e 0,$L_WIDTH,5,$XT_WIDTH,$XT_RHIGH"

    let "WS = $WS + 1"
done

# additional windows for the Home workspace
WS=0
t=`echo $WINDOWS | cut -d\  -f1`
echo "Additional windows for workspace $t ($WS)"
DIR=`eval echo "$""$t""_DIR"`
cd $DIR
run "wmctrl -s $WS"
sleep $DELAY
for a in $HOME_CMDS
do
   echo "... starting $a for $t"
   if [ "$a" = "diary" ]
   then
   	run diary
	# put it at the right edge of the RHS screen
	W=$(($R_WIDTH * 2 / 7))
	H=$(($R_HEIGHT * 4 / 5 ))
	X=$(($L_WIDTH + $R_WIDTH - $W))
	Y=5		# Y=0 gets full size
	sleep $DELAY
   	wmctrl -r GVIM -e 0,$X,$Y,$W,$H
   elif [ "$a" = "thunderbird" ]
   then
	# can I figure out how to size/position this
	unset GTK_MODULES		# Thunderbird bug
   	run "thunderbird &"
   else
   	run "$a >> $LOG 2>> $LOG &"
   fi
   # note: I have not figured out how to reposition these windows
done

# a Chrome recovery will leave all the new windows in the first workspace
echo
echo "To move a Chrome window to another workspace: select it and CTL-ALT-SHIFT ->"
